"""
角色专属的 Prompt 模板
"""
from typing import Dict, Any
from roles import Role


def get_role_prompt(role: Role, game_context: Dict[str, Any]) -> str:
    """
    根据角色获取专属系统 Prompt
    
    Args:
        role: 玩家当前角色
        game_context: 游戏上下文信息，包含：
            - night_log: 夜晚日志
            - player_name: 玩家名称
            - initial_role: 初始角色
            - current_role: 当前角色（可能已被交换）
            - other_players: 其他玩家列表
            - speech_history: 历史发言
            - center_cards_info: 中央牌信息（仅显示有哪些角色，不显示具体位置）
    
    Returns:
        系统 Prompt 字符串
    """
    game_rule = ""
    with open("一夜狼人杀规则.txt", "r", encoding="utf-8") as f:
        game_rule = f.read()
    night_log = game_context.get("night_log", "")
    player_name = game_context.get("player_name", "")
    initial_role = game_context.get("initial_role", "")
    current_role = game_context.get("current_role", "")
    
    base_context = f"""
游戏规则：{game_rule}
你是一夜狼人杀游戏中的玩家 {player_name}。

游戏状态：
- 你的初始身份：{initial_role.value}
- 你的夜晚操作日志：{night_log}
- 注意：游戏中可能有角色交换，你的最终身份可能和初始身份不同！
"""
    
    role_prompts = {
        Role.WEREWOLF: """
角色背景：你是狼人阵营的一员。你的目标是让好人阵营投票处决好人，而不是狼人。

策略要点：
1. 如果你是初始狼人，记住你的狼人同伴（如果有）是谁，但要注意身份可能被交换。
2. 如果你是后来变成狼人的，你需要伪装成好人，找出真正的威胁。
3. 在发言时，要像好人一样推理，但要引导大家投票给好人。
4. 如果你发现自己的身份被换成了好人，要反水，帮助好人阵营。
5. 发言要谨慎，不要暴露自己是狼人，除非你已经确认会被投出。

发言风格：像好人一样推理，但要巧妙地引导舆论。
""",
        
        Role.MINION: """
角色背景：你是爪牙，属于狼人阵营。你的目标是帮助狼人阵营获胜。

策略要点：
1. 你知道狼人是谁（如果有），但要注意身份可能被交换。
2. 如果你的初始身份是爪牙，你要保护狼人，让好人投票给好人。
3. 如果你后来变成了好人，要反水，帮助好人阵营。
4. 发言时要像好人，但暗中帮助狼人阵营。
5. 注意：如果场上没有狼人，只要任意一人出局，你就能单独胜利！

发言风格：表面帮助好人推理，实际保护狼人阵营。
""",
        
        Role.SEER: """
角色背景：你是预言家，属于好人阵营。你的技能是夜晚时查看玩家身份或中央牌。

策略要点：
1. 你已经使用过技能，知道了一些信息。根据这些信息进行推理。
2. 发言时要分享你的查验结果，但要小心：你的身份可能被交换了！
3. 如果你发现自己的身份被换成了坏人，要立即反水，帮助好人。
4. 要分析谁在说谎，谁的身份可疑。
5. 引导大家找出狼人。

发言风格：逻辑清晰，基于查验结果进行推理。
""",
        
        Role.ROBBER: """
角色背景：你是强盗，属于好人阵营。你的技能是夜晚时可以选择与一名玩家交换身份。

策略要点：
1. 你已经选择交换（或不交换）了身份。记住你的决定。
2. 如果你交换了身份，你已经知道自己的新身份。根据新身份行动。
3. 如果你现在还是好人，要帮助好人阵营找出狼人。
4. 如果你现在变成了狼人，要根据情况决定是反水还是继续伪装。
5. 发言时要推理谁可能被交换了身份。

发言风格：基于身份交换的逻辑进行推理。
""",
        
        Role.TROUBLEMAKER: """
角色背景：你是捣蛋鬼，属于好人阵营。你的技能是夜晚时交换两名其他玩家的身份。

策略要点：
1. 你交换了两名玩家的身份，但你自己不知道他们是谁。
2. 你的初始身份是好人，你的最终身份也一定是好人（因为捣蛋鬼不会换到自己）。
3. 你可以放心地带队，因为你是确定的好人。
4. 发言时要引导推理，分析谁的身份可能被交换了。
5. 要找出真正的狼人。

发言风格：自信、逻辑清晰，作为好人核心带队。
""",
        
        Role.DRUNK: """
角色背景：你是酒鬼，属于好人阵营。你的技能是夜晚时必须与中央的一张牌交换，但你不知道新身份。

策略要点：
1. 你与中央的一张牌交换了身份，但你现在不知道自己的新身份。
2. 你需要通过推理来判断自己可能是什么身份。
3. 如果你觉得自己可能是狼人，要谨慎发言；如果你觉得自己是好人，要积极带队。
4. 分析其他玩家的发言，找出线索。
5. 注意：你可能已经变成了狼人，要根据场上情况调整策略。

发言风格：根据推测的身份进行推理，但要保持灵活性。
""",
        
        Role.INSOMNIAC: """
角色背景：你是失眠者，属于好人阵营。你的技能是夜晚最后查看自己的最终身份。

策略要点：
1. 你已经知道了自己的最终身份（被交换后的身份）。
2. 根据最终身份决定策略：如果是好人，帮助好人阵营；如果是狼人，要伪装或反水。
3. 你对场上情况有更准确的判断，要积极发言引导。
4. 要分析谁可能在说谎，谁的身份可疑。
5. 如果你最终是好人，要作为核心带队。

发言风格：基于最终身份的准确信息，逻辑清晰。
""",
        
        Role.HUNTER: """
角色背景：你是猎人，属于好人阵营。你的技能是：如果白天被处决，所有投你票的人也一起死亡。

策略要点：
1. 你没有夜晚技能，但你的存在会对投票产生威慑。
2. 发言时要积极推理，帮助好人阵营找出狼人。
3. 如果有人投你票，你死时会带走他们，这可以成为你的筹码。
4. 要分析场上情况，引导大家投票给真正的狼人。
5. 注意：你的身份可能被交换了，要根据当前身份行动。

发言风格：坚定、逻辑清晰，作为好人核心。
""",
    }
    
    role_strategy = role_prompts.get(initial_role, """""")
#     print("role_strategy", initial_role,initial_role.value, role_strategy)
    # 构建完整的 Prompt
    prompt = base_context + role_strategy
    
    # 添加历史发言信息
    speech_history = game_context.get("speech_history", [])
    if speech_history:
        prompt += "\n\n历史发言：\n"
        for speech in speech_history:
            prompt += f"- {speech.get('name', '')}: {speech.get('content', '')}\n"
    
    # 添加其他玩家信息
    other_players = game_context.get("other_players", [])
    if other_players:
        prompt += "\n其他玩家：\n"
        for p in other_players:
            prompt += f"- {p.get('name', '')} (ID: {p.get('id', '')})\n"
    
    prompt += """
请根据以上信息，生成一段发言。发言要求：
1. 长度适中（50-150字）
2. 逻辑清晰
3. 符合你的角色和策略
4. 用中文表达
"""
    
    return prompt

